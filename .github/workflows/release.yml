name: Release

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - uses: actions/checkout@v4
    
    - uses: dtolnay/rust-toolchain@stable
    
    - name: Verify version matches tag
      run: |
        # Extract version from Cargo.toml
        CARGO_VERSION=$(grep "^version" Cargo.toml | head -1 | cut -d'"' -f2)
        # Extract version from tag (remove 'v' prefix)
        TAG_VERSION=${GITHUB_REF_NAME#v}
        
        echo "Cargo.toml version: $CARGO_VERSION"
        echo "Git tag version: $TAG_VERSION"
        
        if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Cargo.toml version ($CARGO_VERSION) does not match tag version ($TAG_VERSION)"
          exit 1
        fi
    
    - name: Run tests
      run: cargo test --all-features
    
    - name: Publish to crates.io
      run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
      env:
        CRATES_IO_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}